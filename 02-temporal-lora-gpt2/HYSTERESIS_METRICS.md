# Формальные определения метрик гистерезиса роутера

## 1. Switch-lag (инерция переключения)

### Формальное определение

**Switch-lag** = количество токенов после границы сегмента, необходимое для стабильного переключения домена.

**Условия:**
- Домен считается **активным**, когда `w(domain) > threshold` (по умолчанию `threshold = 0.9`)
- **Стабильное переключение** = условие выполняется на `K` подряд токенов (по умолчанию `K = 3`)
- Это исключает одиночные пики/спайки и измеряет устойчивое состояние

**Формула:**
```
switch_lag(domain_idx, switch_point) = min { t | ∀j ∈ [0, K-1]: w[t+j][domain_idx] ≥ threshold }
                                       где t ≥ switch_point
```

**Интерпретация:**
- `switch_lag = 0`: мгновенное переключение (нет инерции)
- `switch_lag > 5`: высокая инерция, роутер "кристаллизуется" в предыдущем состоянии
- Асимметрия `switch_lag(A→B) ≠ switch_lag(B→A)` указывает на гистерезис

---

## 2. Return-gap (память траектории)

### Формальное определение

**Return-gap** = мера различия между первым и вторым сегментом "A" по траектории весов `w(t)`.

### Метрики

#### 2.1. Cosine Distance

**Формула:**
```
cosine_distance(w1, w2) = 1 - cosine_similarity(w1, w2)
                         = 1 - (w1 · w2) / (||w1|| ||w2||)
```

**Важно:** Это **cosine distance**, а не cosine similarity!
- `cosine_distance = 0.0` → векторы идентичны
- `cosine_distance = 1.0` → векторы максимально различно (ортогональны)

**Return-gap (cosine):**
```
return_gap_cosine = mean { cosine_distance(w_A1[i], w_A2[i]) | i ∈ [0, min(len_A1, len_A2)-1] }
```

#### 2.2. Euclidean Distance

```
return_gap_euclidean = mean { ||w_A1[i] - w_A2[i]|| | i ∈ [0, min(len_A1, len_A2)-1] }
```

#### 2.3. Dynamic Time Warping (DTW)

DTW выравнивает последовательности разной длины и вычисляет минимальное расстояние:

```
return_gap_dtw = DTW(w_A1, w_A2)
```

**Интерпретация:**
- `return_gap < 0.05`: второе "A" почти идентично первому → нет памяти траектории
- `return_gap > 0.1`: второе "A" отличается от первого → есть память траектории
- Высокий `return_gap` после микс-сегмента подтверждает гипотезу о "кристаллизации времени"

---

## 3. Hysteresis Loop Area (площадь петли гистерезиса)

### Формальное определение

**Hysteresis Loop Area** = интеграл расхождения между прямой и обратной траекториями.

**Формула:**
```
H = Σ_t |w_A(t) - w_A_rev(t)|
```

где:
- `w_A(t)` = вес домена A на прямой траектории (A→B→A)
- `w_A_rev(t)` = вес домена A на обратной траектории (A→A, без промежуточного B)

**Интерпретация:**
- `H = 0`: нет гистерезиса (прямая и обратная траектории совпадают)
- `H > 0`: есть гистерезис (петля в фазовом пространстве)
- Чем больше `H`, тем сильнее "кристаллизация времени"

---

## 4. Энтропия микс-сегмента

### Формальное определение

**Энтропия распределения весов:**
```
entropy(w) = -Σ_i w[i] * log(w[i] + ε)
```

где `ε = 1e-10` для численной стабильности.

**Интерпретация:**
- `entropy ≈ 0`: один домен доминирует (низкая неопределённость)
- `entropy ≈ log(num_adapters)`: равномерное распределение (максимальная неопределённость)
- Высокая энтропия в микс-сегменте → больше "отпечаток" в памяти траектории

---

## Следующие эксперименты

### A. Зависимость гистерезиса от длины сегмента B

**Эксперимент:**
- Длина B: [4, 8, 16, 32, 64] токенов
- Метрики: `lag(B→A)`, `lag(A→B)`, `return_gap`

**Ожидаемый результат:**
- `lag(B→A)` растёт с длиной B (признак "кристаллизации эпохи")
- `return_gap` также растёт с длиной B

### B. Память микса как функция степени микса

**Эксперимент:**
- Mix режимы: (0.2/0.8), (0.5/0.5), (0.8/0.2)
- Метрика: `return_gap` после возврата к A

**Ожидаемый результат:**
- Максимум памяти около (0.5/0.5) (максимальная неопределённость)

### C. Влияние агрегации весов

**Эксперимент:**
- Режимы: без агрегации, mean pooling, tail-weighted (экспоненциальный)
- Метрики: асимметрия lag, устойчивость на гибридах

**Ожидаемый результат:**
- "Кристаллизация" — эффект динамики агрегации, а не случайность

### D. Контрольный тест: hard-label vs soft-gating

**Эксперимент:**
- Baseline: роутер выдаёт hard-label по argmax (без смешивания)
- Сравнение: `return_gap` для hard-label vs soft-gating

**Ожидаемый результат:**
- Hard-label: `return_gap ≈ 0` (нет непрерывного состояния)
- Soft-gating: `return_gap > 0` (сохраняется память)

**Вывод:** "Время" возникает из непрерывного состояния роутинга.

---

## Ссылки

- `test_hysteresis.py` - реализация метрик
- `HYSTERESIS_TEST_README.md` - описание тестов
- `temporal_lora.py` - основная модель

